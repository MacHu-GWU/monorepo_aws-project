# This is an advanced workflow to show you how to use cache to accelerate CI job run
name: simple_lambda

# Controls when the action will run.
# Reference:
# - on: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#on
# - Events that trigger workflows: https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows
on:
  # To enable a workflow to be triggered manually, you need to configure the workflow_dispatch event.
  # - workflow_dispatch: https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow_dispatch
  # - Manually running a workflow: https://docs.github.com/en/actions/using-workflows/manually-running-a-workflow
  # Allows you to run this workflow manually from the GitHub Actions tab
  workflow_dispatch:
  push:
    branches:
      - 'simple_lambda/feature*'

# Set common environment for all jobs and all steps
env:
  AWS_REGION: "us-east-1"

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read # This is required for actions/checkout

jobs:
  sandbox:
    runs-on: ubuntu-latest
    steps:
      - name: Git clone the repository
        uses: actions/checkout@v4
      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          # this role name has to match the ``github_action_open_id_connection.role_name`` field
          # in ``bootstrap/config.json`` file
          role-to-assume: arn:aws:iam::${{ secrets.DEVOPS_AWS_ACCOUNT_ID }}:role/monorepo-aws-github-oidc
          role-session-name: sample_role_session
          aws-region: ${{ env.AWS_REGION }}
      # ref: https://dev.to/aws-builders/deploy-to-aws-with-github-actions-and-aws-cdk-4m1e
      - name: ğŸ›  Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
      - name: ğŸ’¾ Install CDK in Node
        run: |
          npm install -g aws-cdk@2.111.0
          which cdk
          cdk --version
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          # ref: https://github.com/actions/setup-python#caching-packages-dependencies
          cache: 'poetry'
          cache-dependency-path: projects/simple_lambda-project/poetry.lock
      - name: ğŸ’¾ Install Automation Dependencies
        run: |
          pip install -r ./projects/simple_lambda-project/requirements-automation.txt --quiet --disable-pip-version-check
      - name: ğŸ Create Virtual Environment
        run: |
          python ./projects/simple_lambda-project/bin/s01_01_venv_create.py
      - name: ğŸ’¾ Export resolved dependencies to req-***.txt file
        run: |
          python ./projects/simple_lambda-project/bin/s02_07_poetry_export.py
      - name: ğŸ’¾ Install automation dependencies
        run: |
          python ./projects/simple_lambda-project/bin/s02_05_pip_install_automation.py
      - name: ğŸ’¾ Install main dependencies and Package itself
        run: |
          python ./projects/simple_lambda-project/bin/s02_01_pip_install.py
      - name: ğŸ’¾ Install dev dependencies
        run: |
          python ./projects/simple_lambda-project/bin/s02_02_pip_install_dev.py
      - name: ğŸ’¾ Install test dependencies
        run: |
          python ./projects/simple_lambda-project/bin/s02_03_pip_install_test.py
          

#      - name: sbx
#        env:
#          ENV_NAME: sbx
#        run: |
#          echo $ENV_NAME
#          env
