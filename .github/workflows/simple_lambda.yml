name: simple_lambda

on:
  workflow_dispatch:
  push:
    branches:
      - 'simple_lambda/feature*'
      - 'simple_lambda/feature*'
      - 'simple_lambda/fix*'
      - 'simple_lambda/doc*'
      - 'simple_lambda/layer*'
      - 'simple_lambda/lambda*'
      - 'simple_lambda/release/'
      - 'simple_lambda/cleanup*'

env:
  AWS_REGION: "us-east-1"
  DIR_PROJECT: "projects/simple_lambda-project"

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read # This is required for actions/checkout

jobs:
  job_0_build:
    name: ğŸ§ªï¸ ğŸ— Unit Test and Build Artifacts
    runs-on: ubuntu-latest
    env:
      USER_ENV_NAME: sbx
    steps:
      - name: === ğŸ’¾ PREPARATION ===
        run: echo "PREPARATION"
      - name: Git Clone the Repository
        uses: actions/checkout@v4
      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::${{ secrets.DEVOPS_AWS_ACCOUNT_ID }}:role/monorepo-aws-github-oidc
          role-session-name: devops_role_session
          aws-region: ${{ env.AWS_REGION }}
          disable-retry: true
      - name: ğŸ›  Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
      - name: ğŸ’¾ Install CDK in Node
        run: |
          npm install -g aws-cdk@2.111.0
          which cdk
          cdk --version
      - name: ğŸ Setup Python with pip cache
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'
          cache-dependency-path: ${{ env.DIR_PROJECT }}/requirements-automation.txt
      - name: ğŸ’¾ Install virtualenv, poetry Dependencies
        # poetry version should match the version in pyproject.toml
        run: |
          pip install virtualenv
          pip install poetry==1.6.1
      - name: ğŸ Setup Python with poetry cache
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'poetry'
          cache-dependency-path: ${{ env.DIR_PROJECT }}/poetry.lock
      - name: ğŸ ğŸ’¾ Create Virtual Environment and Install all dependencies
        working-directory: ${{ env.DIR_PROJECT }}
        run: |
          python bin/s02_10_setup_venv_in_ci.py
      - name: === âœ… START MAIN LOGICS ===
        run: echo "START MAIN LOGICS"
      - name: ğŸ—ï¸ Build Lambda Source Artifacts
        working-directory: ${{ env.DIR_PROJECT }}
        run: |
          .venv/bin/python bin/s04_03_lambda_build_source.py
      - name: ğŸ§ª Run Code Coverage Test
        working-directory: ${{ env.DIR_PROJECT }}
        run: |
          .venv/bin/python bin/s03_02_run_cov_test.py
      - name: ğŸ—ï¸ Build Lambda Layer
        working-directory: ${{ env.DIR_PROJECT }}
        run: |
          .venv/bin/python bin/s04_04_lambda_build_layer.py
      - name: ğŸ“” Publish Documentation Website
        working-directory: ${{ env.DIR_PROJECT }}
        run: |
          .venv/bin/python bin/s03_11_build_doc.py
          .venv/bin/python bin/s03_14_deploy_latest_doc.py
      - name: === ğŸ›‘ END OF THE JOB ===
        run: echo "END OF THE JOB"
#  job_1_deploy_to_sbx:
#    name: ğŸš€ Deploy App to ğŸ“¦ sbx
#    uses: MacHu-GWU/monorepo_aws-project/.github/workflows/simple_lambda_deploy.yml@main
#    with:
#      user_env_name: sbx
#    secrets: inherit
#    needs: job_0_build
#
#  job_2_deploy_to_tst:
#    name: ğŸš€ Deploy App to ğŸ§ª tst
#    # we only run this from release branch
#    if: ${{ startsWith(github.ref, 'refs/heads/simple_lambda/release') || startsWith(github.ref, 'refs/heads/simple_lambda/rls') }}
#    uses: MacHu-GWU/monorepo_aws-project/.github/workflows/simple_lambda_deploy.yml@main
#    with:
#      user_env_name: tst
#    secrets: inherit
#    needs: job_1_deploy_to_sbx
#
#  job_3_deploy_to_prd:
#    name: ğŸš€ Deploy App to ğŸ­ prd
#    # we only run this from release branch
#    if: ${{ startsWith(github.ref, 'refs/heads/simple_lambda/release') || startsWith(github.ref, 'refs/heads/simple_lambda/rls') }}
#    uses: MacHu-GWU/monorepo_aws-project/.github/workflows/simple_lambda_deploy.yml@main
#    with:
#      user_env_name: prd
#    secrets: inherit
#    needs: job_2_deploy_to_tst
